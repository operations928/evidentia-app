<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidentia Live Command</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    
    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --text: #e2e8f0; --accent: #3b82f6; --red: #ef4444; --green: #10b981; --orange: #f59e0b; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 220px; background: var(--panel); border-right: 1px solid #334155; display: flex; flex-direction: column; padding: 15px; }
        .logo { font-size: 1.1rem; font-weight: bold; color: var(--accent); margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 10px; }
        
        .clock-section { background: #0f172a; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #334155; text-align: center; }
        .clock-btn { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .btn-in { background: var(--green); color: white; }
        .btn-out { background: var(--red); color: white; }

        .menu-header { font-size: 0.75rem; text-transform: uppercase; color: #64748b; margin: 15px 0 5px 0; font-weight: bold; }
        .nav-btn { background: transparent; border: none; color: #94a3b8; padding: 8px 0; text-align: left; cursor: pointer; display: block; width: 100%; }
        .nav-btn:hover { color: white; }

        /* Main Area */
        .main { flex: 1; display: flex; flex-direction: column; height: 100vh; }
        
        /* MAP (Top 50%) */
        .map-wrapper { flex: 1; position: relative; border-bottom: 2px solid #334155; }
        #map { height: 100%; width: 100%; background: #0f172a; }
        .unit-counter { position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(15,23,42,0.9); padding: 8px 12px; border-radius: 5px; border: 1px solid #334155; font-size: 0.8rem; }

        /* BOTTOM PANEL (Bottom 50%) */
        .bottom-panel { flex: 1; display: flex; overflow: hidden; }
        
        /* RADIO (Left) */
        .radio-box { flex: 1; border-right: 1px solid #334155; display: flex; flex-direction: column; background: #0b1120; }
        .radio-header { padding: 10px; background: var(--panel); border-bottom: 1px solid #334155; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .live-indicator { height: 10px; width: 10px; background: var(--green); border-radius: 50%; display: inline-block; box-shadow: 0 0 5px var(--green); animation: pulse 2s infinite; }
        
        .radio-log-area { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; font-family: monospace; font-size: 0.9rem; }
        .radio-entry { padding: 8px; background: rgba(255,255,255,0.05); border-left: 3px solid var(--accent); border-radius: 0 4px 4px 0; }

        /* PTT Button Area */
        .ptt-area { padding: 20px; background: var(--panel); display: flex; flex-direction: column; align-items: center; gap: 10px; border-top: 1px solid #334155; }
        .ptt-btn { 
            width: 100px; height: 100px; border-radius: 50%; border: 4px solid #475569; 
            background: linear-gradient(145deg, #1e293b, #0f172a); color: #94a3b8; font-weight: bold; font-size: 1rem;
            cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); user-select: none; transition: all 0.1s;
        }
        .ptt-btn:active, .ptt-btn.talking { 
            border-color: var(--orange); background: var(--orange); color: black; box-shadow: 0 0 20px var(--orange); transform: scale(0.95); 
        }

        /* OPS (Right) */
        .ops-box { flex: 1; padding: 20px; overflow-y: auto; background: var(--bg); }
        .ops-title { font-size: 1.1rem; font-weight: bold; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 15px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.85rem; color: #94a3b8; margin-bottom: 5px; }
        .form-control { width: 100%; background: var(--panel); border: 1px solid #334155; color: white; padding: 10px; border-radius: 4px; box-sizing: border-box; }
        .btn-submit { width: 100%; background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="logo">üõ°Ô∏è EVIDENTIA CAD</div>
        <div class="clock-section">
            <div style="font-size:0.8rem; color:#94a3b8;">TIME CLOCK</div>
            <button class="clock-btn btn-in" onclick="clock('in')">CLOCK IN</button>
            <button class="clock-btn btn-out" onclick="clock('out')">CLOCK OUT</button>
            <div id="status-display" style="margin-top:10px; font-size:0.85rem;">Status: Off Duty</div>
        </div>
        
        <div class="menu-header">Operations</div>
        <button class="nav-btn">TOC Tasks</button>
        <button class="nav-btn">Closed Reports</button>
        <button class="nav-btn">Previous Calls</button>
        
        <div class="menu-header">Team</div>
        <button class="nav-btn">Online Members</button>
        <button class="nav-btn">Internal Chat</button>

        <div class="menu-header">Admin</div>
        <button class="nav-btn">Timesheets</button>
        <button class="nav-btn">Training Modules</button>
    </div>

    <div class="main">
        <div class="map-wrapper">
            <div class="unit-counter"><span class="live-indicator"></span> Live Tracking Active</div>
            <div id="map"></div>
        </div>

        <div class="bottom-panel">
            
            <div class="radio-box">
                <div class="radio-header">
                    <span>CHANNEL: MAIN DISPATCH</span>
                    <span style="color:var(--orange); font-size:0.8rem;">VOICE ACTIVE</span>
                </div>
                <div class="radio-log-area" id="radioLogs">
                    <div class="radio-entry">System: Radio Channel Open. Hold PTT to speak.</div>
                </div>
                <div class="ptt-area">
                    <button id="pttBtn" class="ptt-btn">HOLD<br>TO TALK</button>
                    <div style="font-size:0.8rem; color:#64748b;">Status: <span id="radioStatus">Standby</span></div>
                </div>
            </div>

            <div class="ops-box">
                <div class="ops-title">New Operation Report</div>
                
                <div class="form-group" style="margin-bottom:15px;">
                    <label>Operation Type</label>
                    <select id="opType" class="form-control" onchange="updateSub()">
                        <option value="Escort">ATM / CPO Escort</option>
                        <option value="Alarm">Alarm Response</option>
                        <option value="Patrol">Enhanced Patrol</option>
                        <option value="Special">Special Ops (Drone/K9)</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Sub-Type</label>
                        <select id="opSub" class="form-control">
                            <option>Bank</option>
                            <option>Residential</option>
                            <option>Commercial</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" id="opLoc" class="form-control" placeholder="Address">
                    </div>
                </div>

                <div class="form-group">
                    <label>Report Details</label>
                    <textarea id="opDet" class="form-control" rows="3" placeholder="Enter logs, observations, or incident details..."></textarea>
                </div>

                <button class="btn-submit" onclick="submitReport()">SUBMIT TO TOC</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SOCKET.IO & MAP ---
        const socket = io();
        const map = L.map('map').setView([45.4215, -75.6972], 13); // Default: Ottawa
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        const markers = {};

        // Listen for map updates
        socket.on('map-update', (units) => {
            // Remove old markers
            for (let id in markers) map.removeLayer(markers[id]);
            
            // Add new markers
            units.forEach(u => {
                if(u.lat && u.lng) {
                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div style="background:${u.color || '#3b82f6'}; width:12px; height:12px; border-radius:50%; border:2px solid white;"></div>`,
                        iconSize: [15, 15]
                    });
                    const m = L.marker([u.lat, u.lng], {icon: icon}).addTo(map)
                        .bindPopup(`<b>${u.name}</b><br>${u.status}`);
                    markers[u.id] = m;
                }
            });
        });

        // Send MY location (Fake GPS for demo, or real if available)
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                socket.emit('location-update', {
                    id: socket.id,
                    name: 'Officer Unit',
                    status: 'Patrol',
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude
                });
                // Center map on self initially
                // map.setView([pos.coords.latitude, pos.coords.longitude], 14);
            });
        }

        // --- 2. RADIO (PUSH TO TALK) ---
        const pttBtn = document.getElementById('pttBtn');
        const radioStatus = document.getElementById('radioStatus');
        const radioLogs = document.getElementById('radioLogs');
        let mediaRecorder;
        let audioChunks = [];

        // Setup Mic
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks);
                    audioChunks = [];
                    
                    // Send to Server
                    socket.emit('radio-voice', audioBlob);
                    
                    // Log my own transmission
                    addLog("Me", "Transmission Sent");
                };
            })
            .catch(err => {
                alert("Microphone access denied. Radio will not work.");
            });

        // Button Events (Desktop & Mobile Touch)
        function startTalk() {
            if (mediaRecorder && mediaRecorder.state === "inactive") {
                mediaRecorder.start();
                pttBtn.classList.add('talking');
                radioStatus.innerText = "Transmitting...";
                radioStatus.style.color = "var(--orange)";
            }
        }

        function stopTalk() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                pttBtn.classList.remove('talking');
                radioStatus.innerText = "Standby";
                radioStatus.style.color = "#94a3b8";
            }
        }

        pttBtn.addEventListener('mousedown', startTalk);
        pttBtn.addEventListener('mouseup', stopTalk);
        pttBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startTalk(); });
        pttBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopTalk(); });

        // Receive Audio
        socket.on('radio-playback', (arrayBuffer) => {
            const blob = new Blob([arrayBuffer]);
            const audioUrl = URL.createObjectURL(blob);
            const audio = new Audio(audioUrl);
            audio.play();
            addLog("Dispatch/Unit", "Incoming Transmission...");
        });

        function addLog(who, msg) {
            const div = document.createElement('div');
            div.className = 'radio-entry';
            div.innerHTML = `<b>${who}:</b> ${msg}`;
            radioLogs.appendChild(div);
            radioLogs.scrollTop = radioLogs.scrollHeight;
        }

        // --- 3. LOGIC & SUBMIT ---
        function updateSub() {
            // Dynamic dropdown logic here...
        }

        async function submitReport() {
            const type = document.getElementById('opType').value;
            const sub = document.getElementById('opSub').value;
            const loc = document.getElementById('opLoc').value;
            const det = document.getElementById('opDet').value;

            await fetch('/api/operations', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ type, subtype: sub, location: loc, details: det })
            });
            alert("Report Filed Successfully");
            document.getElementById('opDet').value = '';
        }

        async function clock(action) {
            await fetch('/api/clock', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action, officer_name: 'User' })
            });
            document.getElementById('status-display').innerText = action === 'in' ? "Status: ON DUTY" : "Status: OFF DUTY";
        }
    </script>
</body>
</html>
