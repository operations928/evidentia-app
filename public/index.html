<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TOC - Evidence Based Security</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/9203/9203764.png" type="image/x-icon">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        // --- GLOBAL ERROR HANDLER ---
        window.onerror = function(msg, url, line) {
            console.error("Global Error:", msg, "Line:", line);
            // Only alert on critical failures, not warnings
            if (msg.toLowerCase().includes("script error") || msg.toLowerCase().includes("unexpected")) {
                alert("System Error: " + msg);
            }
            return false;
        };

        // --- GLOBALS ---
        let sb = null;
        let socket = null;
        let currentUser = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let currentChannel = 'MAIN';
        let isClockedIn = false; 
        let isIdle = false; 
        let isDispatched = false;
        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let masterGain = audioCtx.createGain(); 
        masterGain.connect(audioCtx.destination);
        
        let myMarker = null; 
        let myPathLine = null; 
        let pathCoords = []; 
        let reportConfig = null;
        let isMuted = false;
        let map = null; 

        // --- SAFE STORAGE ADAPTER ---
        const memoryStorage = {};
        const safeStorageAdapter = {
            getItem: (key) => {
                try { return localStorage.getItem(key); } catch (e) { return memoryStorage[key] || null; }
            },
            setItem: (key, value) => {
                try { localStorage.setItem(key, value); } catch (e) { memoryStorage[key] = value; }
            },
            removeItem: (key) => {
                try { localStorage.removeItem(key); } catch (e) { delete memoryStorage[key]; }
            }
        };

        // --- INIT ---
        const SUPABASE_URL = "https://sxpskjyaughluzefqtor.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN4cHNranlhdWdobHV6ZWZxdG9yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMDM2MDMsImV4cCI6MjA4Mjg3OTYwM30.KO3k4p3YrEOKFX9dxr08B0cZZ_56Jc_IzLWdU0HN5oM";

        try { 
            sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                auth: {
                    storage: safeStorageAdapter,
                    persistSession: true,
                    autoRefreshToken: true,
                    detectSessionInUrl: false
                }
            }); 
            console.log("Supabase Init Success"); 
        } catch (e) { console.error("Init Error:", e); }

        // --- HELPER: SAFE DOM ---
        function safeText(id, text) { const el = document.getElementById(id); if(el) el.innerText = text; }
        function safeVal(id, val) { const el = document.getElementById(id); if(el) el.value = val; }
        function safeShow(id, show) { const el = document.getElementById(id); if(el) el.style.display = show ? 'block' : 'none'; }

        // --- AUTH ---
        function toggleAuth(mode) {
            document.getElementById('loginForm').style.display = mode==='login'?'block':'none';
            document.getElementById('signupForm').style.display = mode==='signup'?'block':'none';
        }

        async function handleLogin() {
            if (!sb) return alert("System Error: Database not connected.");
            const btn = document.getElementById('btnLoginBtn');
            btn.innerText = "AUTHENTICATING..."; btn.disabled = true;

            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const { data, error } = await sb.auth.signInWithPassword({ email, password });
                if(error) {
                    alert("Login Failed: " + error.message);
                    btn.innerText = "AUTHENTICATE"; btn.disabled = false;
                } else {
                    document.getElementById('authModal').style.display = 'none';
                    fetchProfile(data.user.id, data.user.email);
                }
            } catch (e) {
                alert("Login Error: " + e.message);
                btn.innerText = "AUTHENTICATE"; btn.disabled = false;
            }
        }

        async function handleSignup() {
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPass').value;
            const name = document.getElementById('regName').value;
            
            if(password.length < 6) return alert("Password must be at least 6 characters.");

            const { error } = await sb.auth.signUp({ email, password, options: { data: { full_name: name } } });
            if(error) alert("Signup Failed: " + error.message); 
            else {
                alert("Application Submitted. Please Log In.");
                toggleAuth('login');
            }
        }

        async function doLogout() { await sb.auth.signOut(); location.reload(); }

        // --- COMMAND CENTER LOGIC ---
        
        async function loadCommandUsers() {
            const { data } = await sb.from('profiles').select('*').order('rank');
            const div = document.getElementById('cmdUserList');
            if(!div) return;
            div.innerHTML = '<table class="ts-table"><tr><th>Name</th><th>Rank</th><th>Role</th><th>Status</th><th>Actions</th></tr>';
            if(data) {
                data.forEach(u => {
                    div.innerHTML += `
                        <tr>
                            <td>${u.full_name}</td>
                            <td>${u.rank || '-'}</td>
                            <td>${u.
